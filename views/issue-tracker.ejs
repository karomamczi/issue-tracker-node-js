<%- include('./includes/prepend.ejs') %>
    <main>
      <section class="issues__container">
        <ul class="issues__list">
          <% for (let issue of issues) { %>
          <li class="issues__issue__card">
              <div class="issues__issue__card__header">
                <span
                  class="issues__issue__card__header__status <%= 'issues__issue__card__header__status--' + issue.status %>"
                  ><%= issue.status %></span
                >
                <span class="issues__issue__card__header__title"
                  ><%= issue.title %></span
                >
              </div>
              <div class="issues__issue__card__description">
                <%= issue.description %>
              </div>

              <% if (issue.status !== 'closed') { %>
                <div class="issues__issue__card__action">
                    <% if (issue.status === 'open') { %>
                      <button class="issues__issue__card__action--assign" data-id="<%= issue.id %>" data-status="pending" type="submit">Assign</button>
                    <% } %>
                    <% if (issue.status !== 'closed') { %>
                      <button class="issues__issue__card__action--close" data-id="<%= issue.id %>" data-status="closed" type="submit">Close</button>
                    <% } %>
                </div>
              <% } %>
          </li>
          <% } %>
        </ul>
      </div>
    </main>
    <script>
      function patch(id, status) {
        fetch('/issues/update-status/' + id, {
          method: 'PATCH',
          body: JSON.stringify({
            status: status,
          }),
          headers: {
            'Content-type': 'application/json; charset=UTF-8',
          },
        }).then((res) => {
          if (!res.ok) {
            alert('Can\'t update issue to ' + status + ' status!');
          } else {
            location.reload();
          }
        });
      }

      const assignButtons = document.getElementsByClassName('issues__issue__card__action--assign');
      const closeButtons = document.getElementsByClassName('issues__issue__card__action--close');
      const assignButtonsArr = Array.from(assignButtons);
      const closeButtonsArr = Array.from(closeButtons);

      assignButtonsArr.concat(closeButtonsArr).forEach(element => {
        element.addEventListener('click', () => patch(element.dataset.id, element.dataset.status));
      });
    </script>
<%- include('./includes/postpend.ejs') %>
